<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Como parar os descontos do consignado e recuperar sua renda</title>
    <!-- Meta Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1226168308717459');
    fbq('track', 'PageView');
    </script>
    <!-- End Meta Pixel Code -->
  </head>
  <body>
    <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=1226168308717459&ev=PageView&noscript=1"/></noscript>
    <div id="app"></div>
    <script type="module" src="/main.js"></script>
    
    <!-- Setup da LP (snippet) -->
    <script>
    (function(){
      const FUNCTIONS_BASE='https://gwttirszzndoptkxyqhk.supabase.co/functions/v1';
      const LP_LEAD_URL=FUNCTIONS_BASE+'/landing-page-webhook';
      const LP_EVENT_URL=FUNCTIONS_BASE+'/landing-page-webhook/event';

      const ts=()=>Date.now(); const t0=ts(); const minOnPage=()=>Math.max(0,Math.floor((ts()-t0)/60000));
      const getCookie=n=>('; '+document.cookie).split('; '+n+'=').pop()?.split(';').shift();
      const setCookie=(n,v,d=365)=>{const e=new Date();e.setTime(e.getTime()+d*24*60*60*1e3);document.cookie=n+'='+v+';expires='+e.toUTCString()+';path=/;SameSite=Lax'};
      const params=Object.fromEntries(new URLSearchParams(location.search));
      function uuid(){return crypto.randomUUID?crypto.randomUUID():'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)})}
      function externalId(){let id=localStorage.getItem('crm_ext_id');if(!id){id=uuid();localStorage.setItem('crm_ext_id',id)}return id}
      (function(){if(!getCookie('_fbc')&&params.fbclid){const fbc='fb.1.'+Math.floor(ts()/1000)+'.'+params.fbclid;setCookie('_fbc',fbc)}})();

      function pick(form,names){for(const n of names){const el=form.querySelector('[name="'+n+'"]')||form.querySelector('#'+n);if(el)return(el.value||'').trim()}return''}

      function sendLead({name,email,phone,company,formId,phoneValidated=false,extra={}}){
        const body={
          name,email,phone,company,
          form_id:formId||'lp_form',
          landing_page_url:location.href,
          phone_validated: phoneValidated || undefined,
          custom_fields:{ external_id:externalId(), referrer:document.referrer||undefined, page_title:document.title||undefined, ...params, ...extra },
          fbc:getCookie('_fbc')||undefined,
          fbp:getCookie('_fbp')||undefined,
          event_time:ts()
        };
        return fetch(LP_LEAD_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(body),
          mode:'cors',
          credentials:'omit',
          keepalive:true
        });
      }

      function sendEvent(eventType,extras={}){
        const body={ eventType, lead_id:localStorage.getItem('lead_id')||undefined, email:localStorage.getItem('last_lead_email')||undefined, ...extras };
        return fetch(LP_EVENT_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(body),
          mode:'cors',
          credentials:'omit',
          keepalive:true
        });
      }

      document.addEventListener('submit',e=>{
        const form=e.target.closest('form[data-crm-form]'); if(!form) return;
        const email=pick(form,['email','e-mail','email_address']);
        const phone=pick(form,['phone','telefone','whatsapp','celular','phone_number']);
        if(email) localStorage.setItem('last_lead_email',email);
        if(typeof fbq==='function'){
          fbq('track','Lead',{email,phone});
        }
      },true);

      document.addEventListener('click',e=>{
        const el=e.target.closest('[data-crm-whatsapp], a[href*="wa.me/"], a[href*="api.whatsapp.com/"], a[href*="web.whatsapp.com/send"]');
        if(!el) return;
        sendEvent('button_click',{ time_to_contact:String(minOnPage()) });
        if(typeof fbq==='function'){
          fbq('trackCustom','ChamouWhatsApp',{time_to_contact:String(minOnPage())});
        }
      },true);

      // SPA PageView tracking (para quando trocar de rota apÃ³s submit)
      const originalPushState = history.pushState;
      history.pushState = function(){
        const ret = originalPushState.apply(this, arguments);
        if(typeof fbq==='function') fbq('track','PageView');
        return ret;
      };
      window.addEventListener('popstate',()=>{ if(typeof fbq==='function') fbq('track','PageView'); });

      window.MeuNomeCRM={ sendLead, sendEvent, setEmail(email){ if(email) localStorage.setItem('last_lead_email',email) } };
    })();
    </script>
  </body>
</html>